#!/bin/bash

# .chezmoiscripts/run_onchange_install-bun.sh.tmpl
# Automatically installs bun if not present

# Remove set -e to avoid premature exit on potential minor errors or flag issues
# We will handle errors manually.

{{ $shellrc_file := ".bashrc" }}
{{ if eq .chezmoi.os "darwin" }}
{{   $shellrc_file = ".zshrc" }}
{{ end }}

BUN_INSTALL_DIR="$HOME/.bun"
BUN_BIN="$BUN_INSTALL_DIR/bin/bun"

echo "========================================"
echo "Bun Installation Check"
echo "========================================"
echo "DEBUG: HOME=$HOME"
echo "DEBUG: Checking for Bun at $BUN_BIN"

# Check if bun is already installed and working
if command -v bun >/dev/null 2>&1; then
    echo "✓ Bun is already installed: $(which bun)"
    echo "  Version: $(bun --version)"
    exit 0
fi

# Check if bun exists in the expected location but not in PATH
if [ -x "$BUN_BIN" ]; then
    echo "✓ Bun found at $BUN_BIN but not in PATH"
    echo "  Adding to PATH..."
    export PATH="$BUN_INSTALL_DIR/bin:$PATH"
    echo "  Version: $($BUN_BIN --version)"
    exit 0
fi

# Bun is not installed, proceed with installation
echo ""
echo "Bun is not installed."
echo "Installing bun using the official installer..."
echo ""

# Install bun using the official installer
# Explicitly set BUN_INSTALL just in case
export BUN_INSTALL="$BUN_INSTALL_DIR"
# Run installer
if curl -fsSL https://bun.sh/install | bash; then
    echo "Installer finished."
else
    echo "Installer returned error code."
fi

# Setup completions
if [ -x "$BUN_BIN" ]; then
    echo ""
    echo "Setting up bun completions..."
    "$BUN_BIN" completions > /dev/null 2>&1 || true
    echo "✓ Completions configured"
fi

# Verify installation
if [ -x "$BUN_BIN" ]; then
    echo ""
    echo "✓ Bun installed successfully!"

    # Force PATH update for the rest of this script
    export PATH="$BUN_INSTALL_DIR/bin:$PATH"

    echo "  Location: $BUN_BIN"
    # Use direct binary path for version check to be safe
    echo "  Version: $($BUN_BIN --version)"
    echo ""
    echo "Bun has been added to your PATH in the shell configuration."
    echo "To use bun immediately, run: source ~/{{ $shellrc_file }}"
else
    echo "ERROR: Bun installation failed. Binary not found at $BUN_BIN"
    echo "DEBUG: Listing $BUN_INSTALL_DIR/bin:"
    ls -la "$BUN_INSTALL_DIR/bin" 2>/dev/null || echo "Directory not found."
    exit 1
fi

echo "========================================"
